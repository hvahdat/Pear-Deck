-- Should we add usage proportion of total_usage/Total_months_used OR total_usage/months_between_first_last_use?

-- We should exclude Status = 'never used' from analysis, as the focus of this project is specifically on product enhancement. These folks never used the product. There won't be data to analyze.

-- Add: 
-- Type of user (individual vs group vs domain)
-- Adopters vs. Testers (max class size 1-3 people) <--consider 
-- Active vs. Inactive 
-- Usage buckets within active users (what constitutes light - medium - heavy usage?)  
-- correlation between a slide type and user engagement

SELECT date_first_use, date_last_use, DATE_DIFF(DATE(date_first_use), DATE(firstseen), MONTH) as months_until_first_use, DATE_DIFF(DATE(date_last_use), DATE(date_first_use), MONTH) as months_between_first_last_use, CASE WHEN (DATE_DIFF(DATE(date_last_use), DATE(date_first_use), MONTH)) > 0 THEN ROUND(total_months_used/(DATE_DIFF(DATE(date_last_use), DATE(date_first_use), MONTH)), 2) END AS perc_months_used, y.*
FROM
(SELECT 
--old fields
externalid, firstseen, total_usage, Usage_Status, 
--new field
SUM(Date_2017_12_used+Date_2018_01_used+Date_2018_02_used+Date_2018_03_used+Date_2018_04_used+Date_2018_05_used+Date_2018_06_used+Date_2018_07_used+Date_2018_08_used+Date_2018_09_used+Date_2018_10_used+Date_2018_11_used+Date_2018_12_used+Date_2019_01_used+Date_2019_02_used+Date_2019_03_used+Date_2019_04_used+Date_2019_05_used+Date_2019_06_used+Date_2019_07_used+Date_2019_08_used+Date_2019_09_used) as Total_months_used,
--old fields
Date_2017_12, Date_2018_01, Date_2018_02, Date_2018_03, Date_2018_04, Date_2018_05, Date_2018_06, Date_2018_07, Date_2018_08, Date_2018_09, Date_2018_10, Date_2018_11, Date_2018_12, Date_2019_01, Date_2019_02, Date_2019_03, Date_2019_04, Date_2019_05, Date_2019_06, Date_2019_07, Date_2019_08, Date_2019_09, Date_2017_12_used, Date_2018_01_used, Date_2018_02_used, Date_2018_03_used, Date_2018_04_used, Date_2018_05_used, Date_2018_06_used, Date_2018_07_used, Date_2018_08_used, Date_2018_09_used, Date_2018_10_used, Date_2018_11_used, Date_2018_12_used, Date_2019_01_used, Date_2019_02_used, Date_2019_03_used, Date_2019_04_used, Date_2019_05_used, Date_2019_06_used, Date_2019_07_used, Date_2019_08_used, Date_2019_09_used

FROM 
(SELECT *, 

  CASE WHEN Date_2017_12 = 0 THEN 0 ELSE 1 END AS Date_2017_12_used,
  CASE WHEN Date_2018_01 = 0 THEN 0 ELSE 1 END AS Date_2018_01_used,
  CASE WHEN Date_2018_02 = 0 THEN 0 ELSE 1 END AS Date_2018_02_used,
  CASE WHEN Date_2018_03 = 0 THEN 0 ELSE 1 END AS Date_2018_03_used,
  CASE WHEN Date_2018_04 = 0 THEN 0 ELSE 1 END AS Date_2018_04_used,
  CASE WHEN Date_2018_05 = 0 THEN 0 ELSE 1 END AS Date_2018_05_used,
  CASE WHEN Date_2018_06 = 0 THEN 0 ELSE 1 END AS Date_2018_06_used,
  CASE WHEN Date_2018_07 = 0 THEN 0 ELSE 1 END AS Date_2018_07_used,
  CASE WHEN Date_2018_08 = 0 THEN 0 ELSE 1 END AS Date_2018_08_used,
  CASE WHEN Date_2018_09 = 0 THEN 0 ELSE 1 END AS Date_2018_09_used,
  CASE WHEN Date_2018_10 = 0 THEN 0 ELSE 1 END AS Date_2018_10_used,
  CASE WHEN Date_2018_11 = 0 THEN 0 ELSE 1 END AS Date_2018_11_used,
  CASE WHEN Date_2018_12 = 0 THEN 0 ELSE 1 END AS Date_2018_12_used,
  CASE WHEN Date_2019_01 = 0 THEN 0 ELSE 1 END AS Date_2019_01_used,
  CASE WHEN Date_2019_02 = 0 THEN 0 ELSE 1 END AS Date_2019_02_used,
  CASE WHEN Date_2019_03 = 0 THEN 0 ELSE 1 END AS Date_2019_03_used,
  CASE WHEN Date_2019_04 = 0 THEN 0 ELSE 1 END AS Date_2019_04_used,
  CASE WHEN Date_2019_05 = 0 THEN 0 ELSE 1 END AS Date_2019_05_used,
  CASE WHEN Date_2019_06 = 0 THEN 0 ELSE 1 END AS Date_2019_06_used,
  CASE WHEN Date_2019_07 = 0 THEN 0 ELSE 1 END AS Date_2019_07_used,
  CASE WHEN Date_2019_08 = 0 THEN 0 ELSE 1 END AS Date_2019_08_used,
  CASE WHEN Date_2019_09 = 0 THEN 0 ELSE 1 END AS Date_2019_09_used,

  CASE 
    WHEN Total_usage = 0 THEN 'Never Used' 
  END AS Usage_Status
  
FROM
(
SELECT externalid, firstSeen, 
  SUM(Date_2017_12) as Date_2017_12,
  SUM(Date_2018_01) as Date_2018_01,
  SUM(Date_2018_02) as Date_2018_02,
  SUM(Date_2018_03) as Date_2018_03,
  SUM(Date_2018_04) as Date_2018_04,
  SUM(Date_2018_05) as Date_2018_05,
  SUM(Date_2018_06) as Date_2018_06,
  SUM(Date_2018_07) as Date_2018_07,
  SUM(Date_2018_08) as Date_2018_08,
  SUM(Date_2018_09) as Date_2018_09,
  SUM(Date_2018_10) as Date_2018_10,
  SUM(Date_2018_11) as Date_2018_11,
  SUM(Date_2018_12) as Date_2018_12,
  SUM(Date_2019_01) as Date_2019_01,
  SUM(Date_2019_02) as Date_2019_02,
  SUM(Date_2019_03) as Date_2019_03,
  SUM(Date_2019_04) as Date_2019_04,
  SUM(Date_2019_05) as Date_2019_05,
  SUM(Date_2019_06) as Date_2019_06,
  SUM(Date_2019_07) as Date_2019_07,
  SUM(Date_2019_08) as Date_2019_08,
  SUM(Date_2019_09) as Date_2019_09, 
 
  SUM(Date_2017_12+Date_2018_01+Date_2018_02+Date_2018_03+Date_2018_04+Date_2018_05+Date_2018_06+Date_2018_07+Date_2018_08+Date_2018_09+Date_2018_10+Date_2018_11+Date_2018_12+Date_2019_01+Date_2019_02+Date_2019_03+Date_2019_04+Date_2019_05+Date_2019_06+Date_2019_07+Date_2019_08+Date_2019_09) as Total_usage
FROM (
SELECT DISTINCT externalid, firstSeen, 
  CASE WHEN timestamp = '2017-12' THEN COUNT(timestamp) ELSE 0 END AS Date_2017_12,
  CASE WHEN timestamp = '2018-01' THEN COUNT(timestamp) ELSE 0 END AS Date_2018_01,
  CASE WHEN timestamp = '2018-02' THEN COUNT(timestamp) ELSE 0 END AS Date_2018_02,
  CASE WHEN timestamp = '2018-03' THEN COUNT(timestamp) ELSE 0 END AS Date_2018_03,
  CASE WHEN timestamp = '2018-04' THEN COUNT(timestamp) ELSE 0 END AS Date_2018_04,
  CASE WHEN timestamp = '2018-05' THEN COUNT(timestamp) ELSE 0 END AS Date_2018_05,
  CASE WHEN timestamp = '2018-06' THEN COUNT(timestamp) ELSE 0 END AS Date_2018_06,
  CASE WHEN timestamp = '2018-07' THEN COUNT(timestamp) ELSE 0 END AS Date_2018_07,
  CASE WHEN timestamp = '2018-08' THEN COUNT(timestamp) ELSE 0 END AS Date_2018_08,
  CASE WHEN timestamp = '2018-09' THEN COUNT(timestamp) ELSE 0 END AS Date_2018_09,
  CASE WHEN timestamp = '2018-10' THEN COUNT(timestamp) ELSE 0 END AS Date_2018_10,
  CASE WHEN timestamp = '2018-11' THEN COUNT(timestamp) ELSE 0 END AS Date_2018_11,
  CASE WHEN timestamp = '2018-12' THEN COUNT(timestamp) ELSE 0 END AS Date_2018_12,
  CASE WHEN timestamp = '2019-01' THEN COUNT(timestamp) ELSE 0 END AS Date_2019_01,
  CASE WHEN timestamp = '2019-02' THEN COUNT(timestamp) ELSE 0 END AS Date_2019_02,
  CASE WHEN timestamp = '2019-03' THEN COUNT(timestamp) ELSE 0 END AS Date_2019_03,
  CASE WHEN timestamp = '2019-04' THEN COUNT(timestamp) ELSE 0 END AS Date_2019_04,
  CASE WHEN timestamp = '2019-05' THEN COUNT(timestamp) ELSE 0 END AS Date_2019_05,
  CASE WHEN timestamp = '2019-06' THEN COUNT(timestamp) ELSE 0 END AS Date_2019_06,
  CASE WHEN timestamp = '2019-07' THEN COUNT(timestamp) ELSE 0 END AS Date_2019_07,
  CASE WHEN timestamp = '2019-08' THEN COUNT(timestamp) ELSE 0 END AS Date_2019_08,
  CASE WHEN timestamp = '2019-09' THEN COUNT(timestamp) ELSE 0 END AS Date_2019_09
FROM
(SELECT DISTINCT user_id, file_id, slide_id, externalid, firstSeen, FORMAT_DATE("%Y-%m", CAST(CONCAT(SUBSTR(CAST(timestamp AS STRING), 1, 7), "-01") AS DATE)) AS timestamp, EXTRACT(DAY FROM timestamp) as day, EXTRACT(HOUR FROM timestamp) as hour
FROM `peardeck-external-projects.buisness_analytics_in_practice_project.slide_presented` RIGHT JOIN `peardeck-external-projects.buisness_analytics_in_practice_project.user_facts_anonymized` ON `peardeck-external-projects.buisness_analytics_in_practice_project.slide_presented`.user_id = `peardeck-external-projects.buisness_analytics_in_practice_project.user_facts_anonymized`.externalId
WHERE firstSeen >= '2017-12-01 00:00:00 UTC' AND firstSeen < '2019-09-01 00:00:00 UTC'
) a
GROUP BY externalid, firstSeen, timestamp
) b
GROUP BY externalid, firstSeen
) c
ORDER BY Total_usage DESC
) d
GROUP BY externalid, firstseen, total_usage, Usage_Status, Date_2017_12, Date_2018_01, Date_2018_02, Date_2018_03, Date_2018_04, Date_2018_05, Date_2018_06, Date_2018_07, Date_2018_08, Date_2018_09, Date_2018_10, Date_2018_11, Date_2018_12, Date_2019_01, Date_2019_02, Date_2019_03, Date_2019_04, Date_2019_05, Date_2019_06, Date_2019_07, Date_2019_08, Date_2019_09, Date_2017_12_used, Date_2018_01_used, Date_2018_02_used, Date_2018_03_used, Date_2018_04_used, Date_2018_05_used, Date_2018_06_used, Date_2018_07_used, Date_2018_08_used, Date_2018_09_used, Date_2018_10_used, Date_2018_11_used, Date_2018_12_used, Date_2019_01_used, Date_2019_02_used, Date_2019_03_used, Date_2019_04_used, Date_2019_05_used, Date_2019_06_used, Date_2019_07_used, Date_2019_08_used, Date_2019_09_used
) y
JOIN 
(SELECT externalid, MIN(timestamp) AS date_first_use, MAX(timestamp) AS date_last_use
FROM `peardeck-external-projects.buisness_analytics_in_practice_project.slide_presented` RIGHT JOIN `peardeck-external-projects.buisness_analytics_in_practice_project.user_facts_anonymized` ON `peardeck-external-projects.buisness_analytics_in_practice_project.slide_presented`.user_id = `peardeck-external-projects.buisness_analytics_in_practice_project.user_facts_anonymized`.externalId
WHERE firstSeen >= '2017-12-01 00:00:00 UTC' AND firstSeen < '2019-09-01 00:00:00 UTC'
GROUP BY externalid) z
ON y.externalid = z.externalid
ORDER BY total_usage DESC
